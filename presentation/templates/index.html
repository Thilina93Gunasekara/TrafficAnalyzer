<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colombo Live Traffic Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const COLOMBO_LOCATIONS = {
            'Colombo': ['Colombo Fort', 'Pettah', 'Town Hall, Colombo', 'Galle Face', 'Borella'],
            'Gampaha': ['Negombo', 'Gampaha', 'Kadawatha', 'Wattala', 'Kelaniya'],
            'Kalutara': ['Kalutara', 'Panadura'],
            'Colombo Suburbs': [
                'Maharagama', 'Nugegoda', 'Dehiwala', 'Mount Lavinia',
                'Battaramulla', 'Rajagiriya', 'Malabe', 'Moratuwa'
            ]
        };

        function ColomboTrafficDashboard() {
            const [fromLocation, setFromLocation] = useState('Maharagama');
            const [toLocation, setToLocation] = useState('Town Hall, Colombo');
            const [routeData, setRouteData] = useState(null);
            const [predictionData, setPredictionData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [lastUpdate, setLastUpdate] = useState(new Date());
            const [showPredictions, setShowPredictions] = useState(false);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            const fetchRouteData = async () => {
                if (!fromLocation || !toLocation || fromLocation === toLocation) {
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch(
                        `/api/live-dashboard?from=${encodeURIComponent(fromLocation)}&to=${encodeURIComponent(toLocation)}`
                    );
                    const data = await response.json();

                    if (data.success) {
                        setRouteData(data);
                        setLastUpdate(new Date());

                        if (showPredictions) {
                            fetchPredictionData();
                        }
                    }
                } catch (error) {
                    console.error('Error fetching route data:', error);
                } finally {
                    setLoading(false);
                }
            };

            const fetchPredictionData = async () => {
                try {
                    const response = await fetch(
                        `/api/predictions?from=${encodeURIComponent(fromLocation)}&to=${encodeURIComponent(toLocation)}`
                    );
                    const data = await response.json();

                    if (data.success) {
                        setPredictionData(data);
                        updatePredictionChart(data);
                    }
                } catch (error) {
                    console.error('Error fetching predictions:', error);
                }
            };

            const updatePredictionChart = (data) => {
                if (!chartRef.current) return;

                const ctx = chartRef.current.getContext('2d');

                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.hourly_predictions.map(h => `${h.hour}:00`),
                        datasets: [
                            {
                                label: 'Predicted Travel Time',
                                data: data.hourly_predictions.map(h => h.time),
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Historical Average',
                                data: data.hourly_predictions.map(h => h.historical_avg),
                                borderColor: 'rgb(148, 163, 184)',
                                backgroundColor: 'rgba(148, 163, 184, 0.1)',
                                borderDash: [5, 5],
                                tension: 0.4,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: '#fff', font: { size: 12 } }
                            },
                            title: {
                                display: true,
                                text: '24-Hour Travel Time Predictions',
                                color: '#fff',
                                font: { size: 16, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                title: {
                                    display: true,
                                    text: 'Time (minutes)',
                                    color: '#fff'
                                }
                            },
                            x: {
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            };

            useEffect(() => {
                fetchRouteData();
                const interval = setInterval(fetchRouteData, 30000);
                return () => clearInterval(interval);
            }, [fromLocation, toLocation]);

            useEffect(() => {
                if (showPredictions) {
                    fetchPredictionData();
                }
            }, [showPredictions, fromLocation, toLocation]);

            const getTrafficColor = (time) => {
                if (time < 25) return 'from-green-500 to-green-600';
                if (time < 35) return 'from-yellow-500 to-yellow-600';
                if (time < 45) return 'from-orange-500 to-orange-600';
                return 'from-red-500 to-red-600';
            };

            const getWeatherIcon = (condition) => {
                if (condition.includes('Rain')) return 'üåßÔ∏è';
                if (condition.includes('Cloud')) return '‚òÅÔ∏è';
                return '‚òÄÔ∏è';
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-purple-900 p-4">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-6 mb-6 text-white">
                            <div className="mb-6">
                                <h1 className="text-4xl font-bold mb-2">Colombo Live Traffic Dashboard</h1>
                                <p className="text-blue-200">Real-time AI-powered route optimization across Colombo</p>
                            </div>

                            {/* Location Selection */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-semibold mb-2">From Location</label>
                                    <select
                                        value={fromLocation}
                                        onChange={(e) => setFromLocation(e.target.value)}
                                        className="w-full p-3 bg-white bg-opacity-20 border-2 border-white border-opacity-30 rounded-xl text-white focus:outline-none focus:border-opacity-60"
                                    >
                                        {Object.entries(COLOMBO_LOCATIONS).map(([district, locations]) => (
                                            <optgroup key={district} label={district} className="text-gray-900">
                                                {locations.map(loc => (
                                                    <option key={loc} value={loc} className="text-gray-900">{loc}</option>
                                                ))}
                                            </optgroup>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold mb-2">To Location</label>
                                    <select
                                        value={toLocation}
                                        onChange={(e) => setToLocation(e.target.value)}
                                        className="w-full p-3 bg-white bg-opacity-20 border-2 border-white border-opacity-30 rounded-xl text-white focus:outline-none focus:border-opacity-60"
                                    >
                                        {Object.entries(COLOMBO_LOCATIONS).map(([district, locations]) => (
                                            <optgroup key={district} label={district} className="text-gray-900">
                                                {locations.map(loc => (
                                                    <option key={loc} value={loc} className="text-gray-900">{loc}</option>
                                                ))}
                                            </optgroup>
                                        ))}
                                    </select>
                                </div>

                                <div className="flex flex-col justify-end">
                                    <div className="text-right mb-2">
                                        <div className="text-sm text-blue-200">Last Updated</div>
                                        <div className="text-lg font-semibold">{lastUpdate.toLocaleTimeString()}</div>
                                        <div className="text-xs text-blue-300">Auto-refresh: 1hour</div>
                                    </div>
                                </div>
                            </div>

                            {/* Prediction Toggle */}
                            <div className="mt-4 flex items-center justify-between">
                                <button
                                    onClick={() => setShowPredictions(!showPredictions)}
                                    className="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg"
                                >
                                    {showPredictions ? 'üìä Hide Predictions' : 'üìà Show 24h Predictions'}
                                </button>
                                <div className="text-sm">
                                    <span className="bg-green-500 bg-opacity-30 px-3 py-1 rounded-full mr-2">üü¢ System Online</span>
                                    <span className="bg-blue-500 bg-opacity-30 px-3 py-1 rounded-full">ü§ñ AI Active</span>
                                </div>
                            </div>
                        </div>

                        {loading ? (
                            <div className="text-center py-20">
                                <div className="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-white"></div>
                                <p className="text-white text-xl mt-4">Analyzing traffic patterns...</p>
                            </div>
                        ) : !routeData ? (
                            <div className="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-8 text-center text-white">
                                <p className="text-xl">Select origin and destination to view routes</p>
                            </div>
                        ) : (
                            <>
                                {/* Prediction Graph */}
                                {showPredictions && predictionData && (
                                    <div className="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-6 mb-6">
                                        <div style={{ height: '400px', position: 'relative' }}>
                                            <canvas ref={chartRef}></canvas>
                                        </div>
                                        <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div className="bg-blue-500 bg-opacity-30 rounded-xl p-4 text-white text-center">
                                                <div className="text-3xl font-bold">
                                                    {predictionData.best_time_to_travel.hour}:00
                                                </div>
                                                <div className="text-sm mt-1">Best Time to Travel</div>
                                                <div className="text-xs mt-1 opacity-75">
                                                    {predictionData.best_time_to_travel.time} min journey
                                                </div>
                                            </div>
                                            <div className="bg-orange-500 bg-opacity-30 rounded-xl p-4 text-white text-center">
                                                <div className="text-3xl font-bold">
                                                    {predictionData.worst_time_to_travel.hour}:00
                                                </div>
                                                <div className="text-sm mt-1">Worst Time to Travel</div>
                                                <div className="text-xs mt-1 opacity-75">
                                                    {predictionData.worst_time_to_travel.time} min journey
                                                </div>
                                            </div>
                                            <div className="bg-purple-500 bg-opacity-30 rounded-xl p-4 text-white text-center">
                                                <div className="text-3xl font-bold">
                                                    {predictionData.time_savings} min
                                                </div>
                                                <div className="text-sm mt-1">Potential Savings</div>
                                                <div className="text-xs mt-1 opacity-75">
                                                    vs worst time
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Current Conditions */}
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                    <div className="bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl shadow-2xl p-6 text-white">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-xl font-bold">Weather</h3>
                                            <span className="text-4xl">{getWeatherIcon(routeData.current_conditions.weather)}</span>
                                        </div>
                                        <div className="space-y-2">
                                            <div className="text-5xl font-bold">{routeData.current_conditions.temperature}¬∞C</div>
                                            <div className="text-blue-100">{routeData.current_conditions.weather}</div>
                                            <div className="text-sm text-blue-200">Humidity: {routeData.current_conditions.humidity}%</div>
                                            <div className="text-sm text-blue-200">Wind: {routeData.current_conditions.wind_speed} km/h</div>
                                        </div>
                                    </div>

                                    <div className="bg-gradient-to-br from-purple-600 to-purple-700 rounded-2xl shadow-2xl p-6 text-white">
                                        <h3 className="text-xl font-bold mb-4">Current Time</h3>
                                        <div className="text-5xl font-bold mb-2">{routeData.current_conditions.current_time}</div>
                                        <div className="text-purple-100 mb-3">{routeData.current_conditions.day_type}</div>
                                        <div className="space-y-1 text-sm">
                                            <div className="text-purple-200">Traffic: <span className="font-bold">{routeData.current_conditions.traffic_level}</span></div>
                                            <div className="text-purple-200">Season: {routeData.current_conditions.season}</div>
                                        </div>
                                    </div>

                                    <div className={`bg-gradient-to-br ${routeData.holiday_info ? 'from-red-600 to-red-700' : 'from-green-600 to-green-700'} rounded-2xl shadow-2xl p-6 text-white`}>
                                        <h3 className="text-xl font-bold mb-4">Status</h3>
                                        {routeData.holiday_info ? (
                                            <>
                                                <div className="text-4xl mb-2">üéâ</div>
                                                <div className="text-2xl font-bold mb-2">Holiday</div>
                                                <div className="text-sm">{routeData.holiday_info.name}</div>
                                                <div className="mt-3 bg-white bg-opacity-20 rounded-lg p-2 text-sm">Lighter traffic expected</div>
                                            </>
                                        ) : (
                                            <>
                                                <div className="text-4xl mb-2">‚úÖ</div>
                                                <div className="text-2xl font-bold mb-2">Regular Day</div>
                                                <div className="text-sm">Normal traffic patterns</div>
                                            </>
                                        )}
                                    </div>
                                </div>

                                {/* Best Route */}
                                <div className="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-6 mb-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <h2 className="text-3xl font-bold text-white">Recommended Route</h2>
                                        <div className="bg-green-500 text-white px-4 py-2 rounded-full font-bold text-sm animate-pulse">
                                            üèÜ BEST CHOICE
                                        </div>
                                    </div>
                                    <div className="bg-gradient-to-r from-green-500 to-green-600 rounded-2xl p-8 text-white">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <div>
                                                <div className="text-sm text-green-100 mb-2">Route</div>
                                                <div className="text-3xl font-bold">{routeData.best_route.name}</div>
                                            </div>
                                            <div>
                                                <div className="text-sm text-green-100 mb-2">Estimated Time</div>
                                                <div className="text-5xl font-bold">{routeData.best_route.time}</div>
                                                <div className="text-sm text-green-100">minutes</div>
                                            </div>
                                            <div>
                                                <div className="text-sm text-green-100 mb-2">AI Confidence</div>
                                                <div className="flex items-center gap-2">
                                                    <div className="flex-1 bg-white bg-opacity-30 rounded-full h-4">
                                                        <div className="bg-white h-4 rounded-full transition-all"
                                                             style={{width: `${routeData.best_route.confidence}%`}}></div>
                                                    </div>
                                                    <div className="text-xl font-bold">{routeData.best_route.confidence}%</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="mt-6 bg-white bg-opacity-20 rounded-xl p-4">
                                            <div className="font-semibold mb-2">Why This Route?</div>
                                            <ul className="space-y-1 text-sm">
                                                {routeData.best_route.reasons.map((reason, idx) => (
                                                    <li key={idx}>‚Ä¢ {reason}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                {/* All Routes Comparison */}
                                <div className="bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl p-6 mb-6">
                                    <h2 className="text-3xl font-bold text-white mb-6">All Available Routes</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {routeData.all_routes.map((route, idx) => (
                                            <div key={route.name}
                                                 className={`bg-gradient-to-br ${getTrafficColor(route.predicted_time)} rounded-xl shadow-xl p-6 text-white transform transition hover:scale-105 cursor-pointer`}>
                                                <div className="flex items-center justify-between mb-4">
                                                    <h3 className="text-lg font-bold">{route.name}</h3>
                                                    <span className="text-2xl">
                                                        {idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : 'üìç'}
                                                    </span>
                                                </div>
                                                <div className="mb-4">
                                                    <div className="text-5xl font-bold mb-1">{route.predicted_time}</div>
                                                    <div className="text-sm opacity-90">minutes</div>
                                                </div>
                                                <div className="space-y-2 text-sm opacity-90">
                                                    <div className="flex justify-between">
                                                        <span>Distance:</span>
                                                        <span className="font-semibold">{route.distance} km</span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span>Typical:</span>
                                                        <span className="font-semibold">{route.historical_avg} min</span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span>Traffic:</span>
                                                        <span className="font-semibold">{route.traffic_impact}</span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span>Weather:</span>
                                                        <span className="font-semibold">{route.weather_impact}</span>
                                                    </div>
                                                </div>
                                                <div className="mt-4 pt-4 border-t border-white border-opacity-30">
                                                    <div className="text-xs mb-1">Confidence</div>
                                                    <div className="flex items-center gap-2">
                                                        <div className="flex-1 bg-white bg-opacity-30 rounded-full h-2">
                                                            <div className="bg-white h-2 rounded-full"
                                                                 style={{width: `${route.confidence * 100}%`}}></div>
                                                        </div>
                                                        <span className="text-sm font-bold">{Math.round(route.confidence * 100)}%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* AI Insights */}
                                <div className="bg-blue-500 bg-opacity-20 backdrop-blur-lg rounded-2xl p-6 text-white">
                                    <h3 className="text-2xl font-bold mb-4 flex items-center gap-2">
                                        <span>ü§ñ</span>
                                        <span>AI-Powered Insights</span>
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {routeData.insights.map((insight, idx) => (
                                            <div key={idx} className="flex items-start gap-3 bg-white bg-opacity-10 rounded-xl p-4">
                                                <div className="text-xl">üí°</div>
                                                <div className="text-sm flex-1">{insight}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<ColomboTrafficDashboard />, document.getElementById('root'));
    </script>
</body>
</html>